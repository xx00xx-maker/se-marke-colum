import { createClient } from '@supabase/supabase-js'

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY

// ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰åˆ¤å®š
export const isDemoMode = !supabaseUrl || !supabaseAnonKey

if (isDemoMode) {
    console.warn('ğŸ­ ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œä¸­ã€‚.env.localã«Supabaseè¨­å®šã‚’è¿½åŠ ã™ã‚‹ã¨æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã™ã€‚')
}

export const supabase = isDemoMode ? null : createClient(supabaseUrl, supabaseAnonKey)

// ãƒ‡ãƒ¢ç”¨ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿
const DEMO_DATA = {
    themes: [
        "å¶ç„¶ã®å†ä¼šã‹ã‚‰å§‹ã¾ã‚‹ç¦æ–­ã®é–¢ä¿‚",
        "å‡ºå¼µå…ˆã®ãƒ›ãƒ†ãƒ«ãƒãƒ¼ã§ã®å‡ºä¼šã„",
        "é›¨ã®æ—¥ã®ç›¸åˆå‚˜ã‹ã‚‰å§‹ã¾ã‚‹ç‰©èª",
        "å¹¼é¦´æŸ“ã¨ã®æ€ã‚ã¬å†ä¼š",
        "SNSã§è¦‹ã¤ã‘ãŸæ‡ã‹ã—ã„äºº"
    ],
    fragments: [
        "å”‡", "åæ¯", "æœˆæ˜ã‹ã‚Š", "æ²ˆé»™", "æŒ‡å…ˆ",
        "é¼“å‹•", "é¦™ã‚Š", "å›ã", "ç†±", "ç§˜å¯†"
    ]
}

const DEMO_PATTERNS = [
    {
        approach: "ç›´çƒå‹",
        titles: ["ç¦æ–­ã®å¤œã«æººã‚Œã¦", "ã‚ã®äººã¨ã®ç§˜å¯†", "é‹å‘½ã®å†ä¼š", "å¿˜ã‚Œã‚‰ã‚Œãªã„å¤œ", "äºŒäººã ã‘ã®æ™‚é–“"],
        content: "ã‚ã®æ—¥ã€å¶ç„¶ãŒç§ãŸã¡ã‚’å¼•ãå¯„ã›ãŸã€‚\n\né•·ã„é–“å¿˜ã‚Œã¦ã„ãŸã¯ãšã®æ°—æŒã¡ãŒã€å½¼ã®å§¿ã‚’è¦‹ãŸç¬é–“ã«è˜‡ã£ãŸã€‚å¿ƒè‡“ãŒé«˜é³´ã‚Šã€è¨€è‘‰ã‚’å¤±ã†ç§ã€‚å½¼ã‚‚ã¾ãŸã€åŒã˜ã‚ˆã†ã«ç«‹ã¡å°½ãã—ã¦ã„ãŸã€‚\n\nã€Œä¹…ã—ã¶ã‚Šã€\n\nãã®ä¸€è¨€ãŒã€ã™ã¹ã¦ã®å§‹ã¾ã‚Šã ã£ãŸã€‚æ™‚é–“ã¯æ®‹é…·ãªã»ã©é€Ÿãéãã€æ°—ã¥ã‘ã°äºŒäººãã‚Šã®ç©ºé–“ã«ã€‚çª“ã®å¤–ã«ã¯ç…Œã‚ãå¤œæ™¯ã€ãã—ã¦é™ã‹ã«æµã‚Œã‚‹ã‚¸ãƒ£ã‚ºã€‚\n\nå½¼ã®ç³ã«æ˜ ã‚‹ç§ã¯ã€ã‹ã¤ã¦ã¨ã¯é•ã†å¥³ã«ãªã£ã¦ã„ãŸã€‚æˆç†Ÿã—ãŸé­…åŠ›ã€æŠ‘ãˆãã‚Œãªã„æ¬²æœ›ã€‚äº’ã„ã®è¦–ç·šãŒçµ¡ã¿åˆã„ã€è¨€è‘‰ãªãä¼šè©±ãŒç¶šãã€‚\n\nã€Œä»Šå¤œã ã‘ã€éå»ã«æˆ»ã‚Œãªã„ã ã‚ã†ã‹ã€\n\nå½¼ã®å›ãã«ã€ç§ã®ç†æ€§ã¯éŸ³ã‚’ç«‹ã¦ã¦å´©ã‚ŒãŸã€‚"
    },
    {
        approach: "æš—ç¤ºå‹",
        titles: ["æœˆæ˜ã‹ã‚Šã®ç´„æŸ", "æ²ˆé»™ãŒèªã‚‹æƒ³ã„", "è§¦ã‚Œã‚‰ã‚Œãªã„è·é›¢", "æ™‚ã‚’è¶…ãˆãŸæƒ…ç†±", "ç§˜å¯†ã®èŠ±åœ’"],
        content: "æœˆæ˜ã‹ã‚ŠãŒäºŒäººã‚’ç…§ã‚‰ã—ã¦ã„ãŸã€‚\n\nè¨€è‘‰ã¯å¿…è¦ãªã‹ã£ãŸã€‚ãŸã ã€äº’ã„ã®æ¯é£ã„ã ã‘ãŒç©ºé–“ã‚’æº€ãŸã™ã€‚å½¼ã®æŒ‡å…ˆãŒã€ãã£ã¨ç§ã®é ¬ã«è§¦ã‚Œã‚‹ã€‚ã¾ã‚‹ã§å£Šã‚Œç‰©ã‚’æ‰±ã†ã‚ˆã†ã«ã€å„ªã—ãã€ã‘ã‚Œã©ç¢ºã‹ãªæ„å¿—ã‚’æŒã£ã¦ã€‚\n\nç§ã¯ç›®ã‚’é–‰ã˜ãŸã€‚ç¼ã®è£ã«æµ®ã‹ã¶ã®ã¯ã€ã‚ã®æ—¥ã®è¨˜æ†¶ã€‚è‹¥ã•ã‚†ãˆã®æƒ…ç†±ã€ãã—ã¦åˆ¥ã‚Œã€‚ä»Šã€æ™‚ã‚’çµŒã¦å†ã³å·¡ã‚Šä¼šãˆãŸå¥‡è·¡ã«ã€èƒ¸ãŒç· ã‚ä»˜ã‘ã‚‰ã‚Œã‚‹ã€‚\n\nã€Œãšã£ã¨ã€æ¢ã—ã¦ã„ãŸã€\n\nå½¼ã®å£°ãŒéœ‡ãˆã¦ã„ãŸã€‚å¼·ãŒã‚Šã®ä»®é¢ã‚’è„±ã„ã å½¼ã¯ã€ã‚ã®é ƒã¨åŒã˜ç´”ç²‹ã•ã‚’å®¿ã—ã¦ã„ãŸã€‚\n\nç§ãŸã¡ã¯ã€é‹å‘½ã«æŠ—ãˆãªã„ã€‚\n\næœˆãŒé›²ã«éš ã‚Œã‚‹é ƒã€äºŒäººã®å½±ã¯ä¸€ã¤ã«ãªã£ãŸã€‚"
    },
    {
        approach: "ç‰©èªå‹",
        titles: ["é›¨éŸ³ã®ã‚»ãƒ¬ãƒŠãƒ¼ãƒ‡", "ãƒ›ãƒ†ãƒ«ã®ä¸€å¤œ", "é‹å‘½ã¨ã„ã†åã®å¶ç„¶", "ã‚ã®å¤ã®ç¶šã", "ç¦ã˜ã‚‰ã‚ŒãŸæ‹è·¯"],
        content: "é›¨ãŒæ¿€ã—ãçª“ã‚’å©ã„ã¦ã„ãŸã€‚\n\nå‡ºå¼µå…ˆã®ãƒ›ãƒ†ãƒ«ã®ãƒãƒ¼ã€‚ç· ã‚åˆ‡ã‚Šã«è¿½ã‚ã‚Œã‚‹æ—¥ã€…ã‹ã‚‰æŸã®é–“ã®è§£æ”¾ã‚’æ±‚ã‚ã¦ã€ç§ã¯ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã«è…°ã‚’ä¸‹ã‚ã—ãŸã€‚ãƒãƒ¼ãƒ†ãƒ³ãƒ€ãƒ¼ãŒå·®ã—å‡ºã—ãŸã‚«ã‚¯ãƒ†ãƒ«ã«å£ã‚’ã¤ã‘ãŸç¬é–“ã€éš£ã«èª°ã‹ãŒåº§ã‚‹æ°—é…ãŒã—ãŸã€‚\n\næŒ¯ã‚Šå‘ã„ãŸç§ã¯ã€æ¯ã‚’å‘‘ã‚“ã ã€‚\n\nã€Œã¾ã•ã‹ã€ã“ã‚“ãªã¨ã“ã‚ã§ã€\n\n10å¹´ã¶ã‚Šã®å†ä¼šã€‚å­¦ç”Ÿæ™‚ä»£ã€èª°ã«ã‚‚è¨€ãˆãªã„é–¢ä¿‚ã ã£ãŸå½¼ã€‚çµå±€ã€ä½•ã‚‚è¨€ãˆãªã„ã¾ã¾åˆ¥ã€…ã®é“ã‚’æ­©ã‚“ã ã€‚\n\nã€Œé‹å‘½ã ã¨æ€ã‚ãªã„ã‹ã€\n\nå½¼ã®è¨€è‘‰ã«ã€ç§ã¯å¾®ç¬‘ã‚€ã—ã‹ãªã‹ã£ãŸã€‚é‹å‘½ã€‚ãã†ã€ã“ã‚Œã¯é‹å‘½ãªã®ã ã€‚\n\né›¨éŸ³ãŒã€äºŒäººã ã‘ã®ä¸–ç•Œã‚’ä½œã‚Šå‡ºã™ã€‚ã‚°ãƒ©ã‚¹ã‚’å‚¾ã‘ãªãŒã‚‰ã€ç§ãŸã¡ã¯æ™‚é–“ã‚’å–ã‚Šæˆ»ã™ã‚ˆã†ã«èªã‚Šåˆã£ãŸã€‚ãã—ã¦ã€å¤œãŒæ›´ã‘ã‚‹ã«ã¤ã‚Œã€è·é›¢ã¯ç¸®ã¾ã£ã¦ã„ãã€‚\n\nã€Œéƒ¨å±‹ã€æ¥ãªã„ã‹ã€\n\nç­”ãˆã¯ã€è¨€è‘‰ã§ã¯ãªãã€è¡Œå‹•ã§ç¤ºã—ãŸã€‚"
    }
]

/**
 * ãƒŠãƒ¬ãƒƒã‚¸è¨­å®šã‚’å–å¾—
 */
export async function fetchWritingConfig(methodId, templateId) {
    if (isDemoMode) {
        // ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã§ã¯ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™
        return {
            themes: DEMO_DATA.themes,
            fragments: DEMO_DATA.fragments
        }
    }

    const { data, error } = await supabase
        .from('writing_config')
        .select('*')
        .eq('method_id', methodId)
        .eq('template_id', templateId)
        .single()

    if (error) {
        console.error('ãƒŠãƒ¬ãƒƒã‚¸å–å¾—ã‚¨ãƒ©ãƒ¼:', error)
        return null
    }
    return data
}

/**
 * Edge FunctionçµŒç”±ã§ã‚³ãƒ©ãƒ ç”Ÿæˆ
 */
export async function generateColumn({ methodId, templateId, selectedItems, mode }) {
    if (isDemoMode) {
        // ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã§ã¯ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™ï¼ˆå°‘ã—é…å»¶ã‚’å…¥ã‚Œã¦ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¦‹ã›ã‚‹ï¼‰
        await new Promise(resolve => setTimeout(resolve, 2000))
        return { patterns: DEMO_PATTERNS }
    }

    const { data, error } = await supabase.functions.invoke('generate-column', {
        body: { methodId, templateId, selectedItems, mode }
    })

    if (error) {
        throw new Error(error.message || 'ã‚³ãƒ©ãƒ ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ')
    }

    return data.result
}

/**
 * Edge FunctionçµŒç”±ã§AIææ¡ˆã‚’å–å¾—
 */
export async function generateSuggestionsFromAI({ methodId, templateId, mode }) {
    if (isDemoMode) {
        // ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã§ã¯ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™
        await new Promise(resolve => setTimeout(resolve, 500))
        return DEMO_DATA
    }

    const { data, error } = await supabase.functions.invoke('generate-suggestions', {
        body: { methodId, templateId, mode }
    })

    if (error) {
        throw new Error(error.message || 'ææ¡ˆå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ')
    }

    return data.result
}

